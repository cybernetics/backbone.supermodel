// Backbone.Supermodel
// v1.0.0
//
// Copyright (c)2014 Tan Nguyen
// Distributed under MIT license
//
Backbone.SuperModel=function(a,b){var c=function(a,b,c){b=b.split(".");for(var d=b.length,e=0;d>e;e++){if(!a||"object"!=typeof a)return c;a=a[b[e]]}return void 0===a?c:a},d=b.Model.extend({relations:{},unsafeAttributes:[],_getRelation:function(b,c){var f;if(b){var g=a.result(this,"relations");f=g[b]}return c&&!f&&(f=this._valueForCollection(c)?e:d),"undefined"==typeof f&&(f=d),f},_valueForCollection:function(b){return a.isArray(b)?b.length>=1?a.isObject(b[0]):!0:!1},_nestedSet:function(b,c){b=b.split(".");for(var d=b.length-1,e=this,f=0;d>f;++f){var g=b[f],h=e.attributes[g];if(!h){var i=this._getRelation(g,c);e.attributes[g]=new i}e=e.attributes[g]}var j=b[d];if(!a.isArray(c)&&a.isObject(c))for(var k in c){var l=j+"."+k;e._nestedSet(l,c[k])}else if(this._valueForCollection(c)){var m=e.attributes[j];if(!m){var n=this._getRelation(j,c);m=e.attributes[j]=new n}m.add(c)}else e._setChanging(),e.attributes[j]=c,e._setChange(j,c,!0),e._triggerChanges([j],{})},_setChanging:function(){this._previousAttributes=this.toJSON(),this.changed={}},_triggerChanges:function(a,b){a.length&&(this._pending=!0);for(var c=0,d=a.length;d>c;c++){var e=this.get(a[c]);this.trigger("change:"+a[c],this,e,b)}},_setChange:function(b,c,d){var e=this.get(b);return!a.isEqual(e,c)||d?(this.changed[b]=c,!0):(delete this.changed[b],!1)},set:function(a,b,c){var d,e,f,g,h,i;if(null==a)return this;if("object"==typeof a?(e=a,c=b):(e={},e[a]=b),c=c||{},!this._validate(e,c))return!1;f=c.unset,h=c.silent,g=[],i=this._changing,skipNested=c.skipNested,this._changing=!0,i||this._setChanging(),this.idAttribute in e&&(this.id=e[this.idAttribute]);for(d in e)b=e[d],this._setChange(d,b)&&g.push(d),f?this.set(d,void 0,c):skipNested?this.attributes[d]=b:this._nestedSet(d,b);if(h||this._triggerChanges(g,c),i)return this;if(!h)for(;this._pending;)this._pending=!1,this.trigger("change",this,c);return this._pending=!1,this._changing=!1,this},get:function(b){var c=b.split(".");if(c.length>1){var e=this.attributes[a.first(c)];if(!e)return;var f=a.rest(c).join(".");return e instanceof d?e.get(f):e[f]}return this.attributes[b]},toJSON:function(){var c=(a.result(this,"unsafeAttributes"),a.clone(this.attributes));return a.each(this.unsafeAttributes,function(a){delete c[a]}),a.each(c,function(a,d){(a instanceof b.Model||a instanceof b.Collection)&&(c[d]=a.toJSON())}),c},previous:function(a){return null!=a&&this._previousAttributes?c(this._previousAttributes,a):null}}),e=b.Collection.extend({model:d});return d}(_,Backbone);